<div class="relative">
  <%= link_to episode_path(result[:episode].episode_id, segment: result[:match].position), 
      class: "block px-4 py-4 hover:bg-gray-50 border-b border-gray-100 last:border-b-0 transition-all duration-200 ease-in-out hover:translate-x-1 cursor-pointer group",
      data: { turbo_frame: "_top" } do %>
    <div class="flex flex-col sm:flex-row sm:items-start gap-3">
      <span class="text-sm font-mono text-gray-500 bg-gray-100 px-2 py-1 rounded self-start">
        <%= format_timestamp(result[:match].timestamp_from) %>
      </span>
      <div class="flex-1 space-y-1">
        <% result[:context_segments].each do |segment| %>
          <% is_match = segment.id == result[:match].id %>
          <% if is_match %>
            <div class="border-l-4 border-blue-500 pl-3 py-1 bg-blue-50 relative">
              <p class="text-gray-900 font-medium pr-8">
                <%= highlight_matches(segment.text, @query) %>
              </p>
              <!-- Favorite button for the match segment -->
              <div class="absolute top-1 right-1">
                <% if segment.favorited? %>
                  <%= form_with url: favorite_segment_path(segment.id), method: :delete, local: true, class: "inline-block" do |form| %>
                    <%= form.hidden_field :transcript_segment_id, value: segment.id %>
                    <%= form.button type: :submit, onclick: "event.preventDefault(); event.stopPropagation(); this.closest('form').submit();", class: "p-1 rounded-full hover:bg-white/50 transition-colors" do %>
                      <svg class="w-4 h-4 text-red-500 hover:text-red-600" fill="currentColor" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                      </svg>
                    <% end %>
                  <% end %>
                <% else %>
                  <%= form_with url: favorite_segments_path, method: :post, local: true, class: "inline-block" do |form| %>
                    <%= form.hidden_field :transcript_segment_id, value: segment.id %>
                    <%= form.button type: :submit, onclick: "event.preventDefault(); event.stopPropagation(); this.closest('form').submit();", class: "p-1 rounded-full hover:bg-white/50 transition-colors" do %>
                      <svg class="w-4 h-4 text-gray-400 hover:text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                      </svg>
                    <% end %>
                  <% end %>
                <% end %>
              </div>
            </div>
          <% else %>
            <div class="pl-3 border-l-2 border-gray-200">
              <p class="text-gray-600 text-sm leading-relaxed">
                <%= segment.text %>
              </p>
            </div>
          <% end %>
        <% end %>
      </div>
    </div>
  <% end %>
</div>